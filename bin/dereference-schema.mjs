// @ts-check
import RefParser from 'json-schema-ref-parser'
import * as fs from 'fs/promises'
import meow from 'meow'
import { createRequire } from 'module'
import path from 'path'

/** ********************************************************
 *
 * This script goes through the json-schemas and generates
 * dereferenced versions for consumption by other services
 *
 ***********************************************************/

const cli = meow(
  `
	Tool to resolve references in JSON Schemas

	Usage
		$ blueprint-schema-deref <input-file-1> <input-file-N> <output-path>
    
	Examples
		$ blueprint-schema-deref ./src/$schemas/showStyle.json ./src/$schemas/studio.json ./src/generated/$schemas
`,
  {
    importMeta: import.meta,
  }
)

const inputFiles = cli.input.slice(0, -1)
const outputPath = cli.input[cli.input.length - 1]

if (inputFiles.length === 0 || !outputPath) {
  cli.showHelp()
  process.exit(1)
}

const BANNER =
  '/* eslint-disable */\n/**\n * This file was automatically generated by blueprint-schema-deref.\n * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,\n * and run "yarn deref-schema" to regenerate this file.\n */\n'

await fs.mkdir(outputPath, { recursive: true })

const resolvedOutputPath = path.resolve(outputPath)

const refParser = new RefParser()

for (const filename of inputFiles) {
  try {
    const derefedSchema = await refParser.dereference(filename, {
      parse: {
        json: true,
        yaml: true,
        text: true,
      },
      dereference: {
        circular: false,
      },
      continueOnError: true,
      resolve: {
        external: false,
        file: true,
        http: true,
      }
    })

    await fs.writeFile(path.join(resolvedOutputPath, path.parse(filename).name + '.json'), BANNER + '\n' + JSON.stringify(derefedSchema, undefined, 2))
  } catch (e) {
    console.error(`Error while generating ${filename}, continuing...`)
    console.error(e)
  }
}
